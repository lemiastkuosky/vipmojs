<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roleta de Prêmios</title>
    <link rel="stylesheet" href="style.css">
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>

    <header class="user-header">
        <span id="user-email"></span>
    </header>

    <div class="main-container">
        <div class="controles" style="display: none;">
            <h3>Gerenciar Prêmios</h3>
            <div class="form-premio">
                <input type="text" id="nome-premio-input" placeholder="Nome do Prêmio">
                <input type="color" id="cor-premio-input" value="#3498db">
                <button id="add-premio-btn">Adicionar</button>
            </div>
            <h4>Lista de Prêmios Atuais</h4>
            <ul id="lista-premios"></ul>
        </div>

        <div class="container">
            <div class="roleta-container">
                <div class="seta"></div>
                <div class="roleta" id="roleta"></div>
            </div>
            <button id="girar-btn">Girar a Roleta!</button>
            <p id="giros-restantes"></p> </div>
    </div>

    <div class="historico-container">
        <h2>Seu Histórico de Prêmios</h2>
        <ul id="historico-lista">
            </ul>
    </div>

    <audio id="som-giro" src="spinning.mp3" loop></audio>
    <audio id="som-vitoria" src="win.mp3"></audio>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="firebase-config.js"></script>
    
    <script>
        // --- Constantes e Variáveis de Estado ---
        const LIMITE_GIROS = 5; // Defina o limite de giros por dia aqui
        let isGirando = false;
        let premios = [];
        let girosRestantes = LIMITE_GIROS;
        let currentUser = null;

        // --- Elementos do DOM ---
        const painelDeControles = document.querySelector('.controles');
        const userHeader = document.querySelector('.user-header');
        const userEmailSpan = document.getElementById('user-email');
        const girarBtn = document.getElementById('girar-btn');
        const girosRestantesP = document.getElementById('giros-restantes');
        const roleta = document.getElementById('roleta');
        const historicoListaUl = document.getElementById('historico-lista');
        // ... (resto dos elementos do DOM para admin e sons)
        const addPremioBtn = document.getElementById('add-premio-btn');
        const nomePremioInput = document.getElementById('nome-premio-input');
        const corPremioInput = document.getElementById('cor-premio-input');
        const listaPremiosUl = document.getElementById('lista-premios');
        const somGiro = document.getElementById('som-giro');
        const somVitoria = document.getElementById('som-vitoria');

        // --- Funções ---

        // (Funções renderizarRoleta e renderizarListaAdmin continuam as mesmas)
        function renderizarRoleta() {
            roleta.innerHTML = ''; if (premios.length === 0) return;
            const anguloPorFatia = 360 / premios.length;
            premios.forEach((premio, i) => {
                const fatia = document.createElement('div');
                fatia.style.cssText = `position: absolute; width: 50%; height: 50%; background-color: ${premio.color || '#cccccc'}; transform-origin: 100% 100%; transform: rotate(${i * anguloPorFatia}deg) skewX(${90 - anguloPorFatia}deg);`;
                const texto = document.createElement('span');
                texto.textContent = premio.name;
                texto.style.cssText = `position: absolute; color: #FFFFFF; left: 10%; top: 20%; transform: skewX(${-(90 - anguloPorFatia)}deg) rotate(${anguloPorFatia / 2}deg); font-size: 13px; font-weight: bold; text-shadow: 1px 1px 3px rgba(0,0,0,0.7); display: block; max-width: 80%; word-wrap: break-word;`;
                fatia.appendChild(texto);
                roleta.appendChild(fatia);
            });
        }
        function renderizarListaAdmin() { /* ...código de renderizarListaAdmin... */ }


        // NOVA FUNÇÃO para carregar o histórico
        async function carregarHistorico(userId) {
            historicoListaUl.innerHTML = '<li>Carregando histórico...</li>';
            try {
                const snapshot = await db.collection('sorteios').where('userId', '==', userId).orderBy('data', 'desc').limit(10).get();
                if (snapshot.empty) {
                    historicoListaUl.innerHTML = '<li>Você ainda não ganhou prêmios.</li>';
                    return;
                }
                historicoListaUl.innerHTML = '';
                snapshot.forEach(doc => {
                    const sorteio = doc.data();
                    const li = document.createElement('li');
                    const dataFormatada = sorteio.data.toDate().toLocaleString('pt-BR');
                    li.innerHTML = `<b>${sorteio.premio}</b> - <span>${dataFormatada}</span>`;
                    historicoListaUl.appendChild(li);
                });
            } catch (error) {
                console.error("Erro ao carregar histórico: ", error);
                historicoListaUl.innerHTML = '<li>Não foi possível carregar o histórico.</li>';
            }
        }
        
        // NOVA FUNÇÃO para checar e atualizar os giros diários
        async function checarGirosDiarios(user) {
            const userDocRef = db.collection('users').doc(user.uid);
            const doc = await userDocRef.get();
            const userData = doc.data() || {};
            
            const hoje = new Date().toDateString();
            const ultimoGiroDia = userData.ultimoGiroEm ? userData.ultimoGiroEm.toDate().toDateString() : null;

            if (hoje !== ultimoGiroDia) {
                // Se o último giro foi em um dia diferente, reseta o contador
                await userDocRef.set({ girosHoje: 0 }, { merge: true });
                girosRestantes = LIMITE_GIROS;
            } else {
                girosRestantes = LIMITE_GIROS - (userData.girosHoje || 0);
            }

            atualizarStatusBotaoGirar();
        }

        function atualizarStatusBotaoGirar() {
            if (girosRestantes <= 0) {
                girarBtn.disabled = true;
                girosRestantesP.textContent = "Você não tem mais giros hoje. Volte amanhã!";
            } else {
                girarBtn.disabled = isGirando;
                girosRestantesP.textContent = `Você tem ${girosRestantes} giro(s) restante(s).`;
            }
        }

        // NOVA FUNÇÃO para registrar o giro no banco de dados
        async function registrarGiro(userId, premioGanhado) {
            const userDocRef = db.collection('users').doc(userId);
            const sorteioRef = db.collection('sorteios');
            
            // Incrementa o contador de giros e atualiza a data
            await userDocRef.set({ 
                girosHoje: firebase.firestore.FieldValue.increment(1),
                ultimoGiroEm: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });

            // Adiciona o prêmio ao histórico
            await sorteioRef.add({
                userId: userId,
                premio: premioGanhado.name,
                data: firebase.firestore.FieldValue.serverTimestamp()
            });

            // Atualiza a tela
            girosRestantes--;
            atualizarStatusBotaoGirar();
            carregarHistorico(userId);
        }

        // --- Lógica de Autenticação e Inicialização ---
        auth.onAuthStateChanged(async user => {
            if (user) {
                currentUser = user; // Guarda o usuário atual
                userEmailSpan.textContent = `Logado como: ${user.email}`;
                adicionarBotaoLogout(userHeader);

                // Checa se é admin
                const userDocRef = db.collection('users').doc(user.uid);
                const doc = await userDocRef.get();
                if (doc.exists && doc.data().role === 'admin') {
                    painelDeControles.style.display = 'block';
                }
                
                // Carrega tudo
                await carregarPremiosERenderizarTudo();
                await checarGirosDiarios(user);
                await carregarHistorico(user.uid);
            } else {
                window.location.href = 'login.html';
            }
        });

        // --- Event Listener do Giro (ATUALIZADO) ---
        girarBtn.addEventListener('click', () => {
            if (isGirando || girosRestantes <= 0 || premios.length < 2) return;
            
            isGirando = true;
            girarBtn.disabled = true;
            girarBtn.textContent = 'Girando...';
            try { somGiro.play(); } catch(e) {}

            const indiceVencedor = Math.floor(Math.random() * premios.length);
            const premioVencedor = premios[indiceVencedor];
            const anguloPorFatia = 360 / premios.length;
            
            const voltasExtras = 5 * 360;
            const anguloFinal = voltasExtras + (360 - (indiceVencedor * anguloPorFatia) - (anguloPorFatia / 2));
            
            roleta.style.transition = 'transform 6s cubic-bezier(0.1, 0.7, 0.3, 1)';
            roleta.style.transform = `rotate(${anguloFinal}deg)`;

            setTimeout(() => {
                try { somGiro.pause(); somGiro.currentTime = 0; somVitoria.play(); } catch(e) {}

                Swal.fire({
                    icon: 'success',
                    title: 'Parabéns!',
                    html: `Você ganhou: <b>${premioVencedor.name}</b>`
                });

                isGirando = false;
                // A função registrarGiro vai re-habilitar o botão se houver giros
                registrarGiro(currentUser.uid, premioVencedor);
            }, 6500);
        });

        // (Listeners de Adicionar/Remover prêmio e função de logout continuam iguais)
        addPremioBtn.addEventListener('click', async () => { /* ...código de addPremioBtn... */ });
        listaPremiosUl.addEventListener('click', async (e) => { /* ...código de listaPremiosUl... */ });
        function adicionarBotaoLogout(container) { /* ...código de adicionarBotaoLogout... */ }
    </script>
</body>
</html>