<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roleta de Prêmios</title>
    <link rel="stylesheet" href="style.css">
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
    <header class="user-header">
        <span id="user-email"></span>
        </header>

    <div class="main-container">
        </div>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="firebase-config.js"></script>
    
    <script>
        // --- VARIÁVEIS ---
        let isGirando = false;
        let premios = [];
        let girosRestantes = 0;
        let limiteGirosUsuario = 5; // Padrão
        let currentUser = null;

        // --- ELEMENTOS DO DOM (simplificado para clareza) ---
        const userHeader = document.querySelector('.user-header');
        const girarBtn = document.getElementById('girar-btn');
        const girosRestantesP = document.getElementById('giros-restantes');
        const roleta = document.getElementById('roleta');
        // ... (outros elementos)

        // --- FUNÇÕES ---

        // (carregarPremiosERenderizarTudo, renderizarRoleta, carregarHistorico, registrarGiro...)

        // ATUALIZADA: checarGirosDiarios agora lê o limite do usuário
        async function checarGirosDiarios(user) {
            const userDocRef = db.collection('users').doc(user.uid);
            try {
                const doc = await userDocRef.get();
                const userData = doc.data() || {};
                
                // Lê o limite de giros do usuário ou usa o padrão 5
                limiteGirosUsuario = userData.limiteGiros ?? 5;

                const hoje = new Date().toDateString();
                const ultimoGiroDia = (userData.ultimoGiroEm && userData.ultimoGiroEm.toDate) ? userData.ultimoGiroEm.toDate().toDateString() : null;
                
                if (hoje !== ultimoGiroDia) {
                    await userDocRef.update({ girosHoje: 0 });
                    girosRestantes = limiteGirosUsuario;
                } else {
                    girosRestantes = Math.max(0, limiteGirosUsuario - (userData.girosHoje || 0));
                }
            } catch (error) {
                girosRestantes = 0;
            }
            atualizarStatusBotaoGirar();
        }

        // ATUALIZADA: atualizarStatusBotaoGirar usa a variável correta
        function atualizarStatusBotaoGirar() {
            if (girosRestantes <= 0) {
                girarBtn.disabled = true;
                girosRestantesP.textContent = "Você não tem mais giros hoje. Volte amanhã!";
            } else {
                girarBtn.disabled = isGirando;
                girosRestantesP.textContent = `Você tem ${girosRestantes} de ${limiteGirosUsuario} giros restantes.`;
            }
        }

        // NOVA FUNÇÃO: Sorteio ponderado
        function selecionarPremioPonderado() {
            const totalPeso = premios.reduce((sum, p) => sum + (p.peso || 1), 0);
            let random = Math.random() * totalPeso;

            for (const premio of premios) {
                random -= (premio.peso || 1);
                if (random <= 0) {
                    return premio;
                }
            }
            return premios[premios.length - 1]; // Fallback
        }

        // --- EVENT LISTENER DO GIRO (ATUALIZADO) ---
        girarBtn.addEventListener('click', () => {
            if (isGirando || girosRestantes <= 0 || premios.length < 1) return;
            
            isGirando = true;
            girarBtn.disabled = true;
            girarBtn.textContent = 'Girando...';
            
            const premioVencedor = selecionarPremioPonderado();
            const indiceVencedor = premios.findIndex(p => p.id === premioVencedor.id);
            
            // Lógica de animação...
            // ...

            setTimeout(() => {
                // ...
                registrarGiro(currentUser.uid, premioVencedor);
            }, 6500);
        });
        
        // --- INICIALIZAÇÃO (ATUALIZADA) ---
        auth.onAuthStateChanged(async user => {
            if (user) {
                // ...
                if (doc.exists && doc.data().role === 'admin') {
                    // Adiciona o link para o painel de admin
                    const adminLink = document.createElement('a');
                    adminLink.href = 'admin.html';
                    adminLink.textContent = 'Painel do Admin';
                    adminLink.className = 'admin-link';
                    userHeader.appendChild(adminLink);
                }
                // ...
            } 
        });

    </script>
</body>
</html>