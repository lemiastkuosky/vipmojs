<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roleta de Prêmios</title>
    <link rel="stylesheet" href="style.css">
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>

    <header class="user-header">
        <span id="user-email"></span>
    </header>

    <div class="main-container">
        <div class="controles" style="display: none;">
            <h3>Gerenciar Prêmios</h3>
            <div class="form-premio">
                <input type="text" id="nome-premio-input" placeholder="Nome do Prêmio">
                <input type="color" id="cor-premio-input" value="#3498db">
                <button id="add-premio-btn">Adicionar</button>
            </div>
            <h4>Lista de Prêmios Atuais</h4>
            <ul id="lista-premios"></ul>
        </div>

        <div class="container">
            <div class="roleta-container">
                <div class="seta"></div>
                <div class="roleta" id="roleta"></div>
            </div>
            <button id="girar-btn">Girar a Roleta!</button>
            <p id="giros-restantes"></p>
        </div>
    </div>

    <div class="historico-container">
        <h2>Seu Histórico de Prêmios</h2>
        <ul id="historico-lista"></ul>
    </div>

    <audio id="som-giro" src="spinning.mp3" loop></audio>
    <audio id="som-vitoria" src="win.mp3"></audio>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="firebase-config.js"></script>
    
    <script>
        // --- CONSTANTES E VARIÁVEIS ---
        const LIMITE_GIROS = 5;
        let isGirando = false;
        let premios = [];
        let girosRestantes = LIMITE_GIROS;
        let currentUser = null;

        // --- ELEMENTOS DO DOM ---
        const painelDeControles = document.querySelector('.controles');
        const userHeader = document.querySelector('.user-header');
        const userEmailSpan = document.getElementById('user-email');
        const girarBtn = document.getElementById('girar-btn');
        const girosRestantesP = document.getElementById('giros-restantes');
        const roleta = document.getElementById('roleta');
        const historicoListaUl = document.getElementById('historico-lista');
        const addPremioBtn = document.getElementById('add-premio-btn');
        const nomePremioInput = document.getElementById('nome-premio-input');
        const corPremioInput = document.getElementById('cor-premio-input');
        const listaPremiosUl = document.getElementById('lista-premios');
        const somGiro = document.getElementById('som-giro');
        const somVitoria = document.getElementById('som-vitoria');

        // --- FUNÇÕES DE RENDERIZAÇÃO E LÓGICA ---

        async function carregarPremiosERenderizarTudo() {
            try {
                const snapshot = await db.collection('premios').get();
                premios = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderizarRoleta();
                if (painelDeControles.style.display === 'block') {
                    renderizarListaAdmin();
                }
            } catch (error) {
                console.error("Erro ao carregar prêmios: ", error);
            }
        }

        function renderizarRoleta() {
            roleta.innerHTML = '';
            if (premios.length === 0) return;
            const anguloPorFatia = 360 / premios.length;

            premios.forEach((premio, i) => {
                const fatia = document.createElement('div');
                fatia.style.cssText = `
                    position: absolute;
                    width: 50%;
                    height: 50%;
                    background-color: ${premio.color || '#cccccc'};
                    transform-origin: 100% 100%;
                    transform: rotate(${i * anguloPorFatia}deg) skewX(${90 - anguloPorFatia}deg);
                `;
                
                // ===============================================
                // CSS CORRIGIDO E ROBUSTO PARA O TEXTO
                // ===============================================
                const texto = document.createElement('div'); // Usar DIV para melhor controle
                texto.style.cssText = `
                    position: absolute;
                    width: 100%;
                    height: 100%;
                    transform-origin: 100% 100%;
                    transform: rotate(${i * anguloPorFatia}deg) skewX(${90 - anguloPorFatia}deg);
                    
                    /* Desfaz o skew para o conteúdo interno */
                    transform: rotate(${i * anguloPorFatia}deg) translateX(-50%) rotate(-${anguloPorFatia/2 + 90}deg);
                    left: 50%;
                    top: 0;

                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding-right: 25%; /* Empurra para o centro da fatia */
                `;
                
                const p = document.createElement('p');
                p.textContent = premio.name;
                p.style.cssText = `
                    color: white;
                    font-size: 13px;
                    font-weight: bold;
                    text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
                    max-width: 80%;
                    word-wrap: break-word;
                    text-align: center;
                `;
                texto.appendChild(p);

                // Adiciona o container do texto à roleta (não à fatia)
                roleta.appendChild(fatia);
                roleta.appendChild(texto);
            });
        }


        function renderizarListaAdmin() {
            listaPremiosUl.innerHTML = '';
            premios.forEach(premio => {
                const li = document.createElement('li');
                li.textContent = premio.name;
                li.style.borderLeft = `5px solid ${premio.color}`;
                const removeBtn = document.createElement('button');
                removeBtn.textContent = 'Remover';
                removeBtn.dataset.id = premio.id;
                li.appendChild(removeBtn);
                listaPremiosUl.appendChild(li);
            });
        }

        async function carregarHistorico(userId) {
            historicoListaUl.innerHTML = '<li>Carregando...</li>';
            try {
                const snapshot = await db.collection('sorteios').where('userId', '==', userId).orderBy('data', 'desc').limit(10).get();
                if (snapshot.empty) {
                    historicoListaUl.innerHTML = '<li>Você ainda não ganhou prêmios. Gire a roleta!</li>';
                } else {
                    historicoListaUl.innerHTML = '';
                    snapshot.forEach(doc => {
                        const sorteio = doc.data();
                        const li = document.createElement('li');
                        const dataFormatada = sorteio.data ? sorteio.data.toDate().toLocaleString('pt-BR') : 'agora mesmo';
                        li.innerHTML = `<b>${sorteio.premio}</b> - <span>${dataFormatada}</span>`;
                        historicoListaUl.appendChild(li);
                    });
                }
            } catch (error) {
                console.error("Erro ao carregar histórico: ", error);
                historicoListaUl.innerHTML = '<li>Não foi possível carregar o histórico.</li>';
            }
        }
        
        async function checarGirosDiarios(user) {
            const userDocRef = db.collection('users').doc(user.uid);
            try {
                const doc = await userDocRef.get();
                const userData = doc.data() || {};
                const hoje = new Date().toDateString();
                const ultimoGiroDia = (userData.ultimoGiroEm && userData.ultimoGiroEm.toDate) ? userData.ultimoGiroEm.toDate().toDateString() : null;
                if (hoje !== ultimoGiroDia) {
                    await userDocRef.set({ girosHoje: 0 }, { merge: true });
                    girosRestantes = LIMITE_GIROS;
                } else {
                    girosRestantes = Math.max(0, LIMITE_GIROS - (userData.girosHoje || 0));
                }
            } catch (error) {
                console.error("Erro ao checar giros diários:", error);
                girosRestantes = 0;
            }
            atualizarStatusBotaoGirar();
        }

        function atualizarStatusBotaoGirar() {
            if (girosRestantes <= 0) {
                girarBtn.disabled = true;
                girosRestantesP.textContent = "Você não tem mais giros hoje. Volte amanhã!";
            } else {
                girarBtn.disabled = isGirando;
                girosRestantesP.textContent = `Você tem ${girosRestantes} giro(s) restante(s).`;
            }
        }

        async function registrarGiro(userId, premioGanhado) {
            const userDocRef = db.collection('users').doc(userId);
            const sorteioRef = db.collection('sorteios');
            await userDocRef.set({
                girosHoje: firebase.firestore.FieldValue.increment(1),
                ultimoGiroEm: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
            await sorteioRef.add({
                userId: userId,
                premio: premioGanhado.name,
                data: firebase.firestore.FieldValue.serverTimestamp()
            });
            girosRestantes--;
            atualizarStatusBotaoGirar();
            await carregarHistorico(userId);
        }
        
        function adicionarBotaoLogout(container) {
            if (document.getElementById('btn-logout')) return;
            const logoutButton = document.createElement('button');
            logoutButton.id = 'btn-logout';
            logoutButton.textContent = 'Sair';
            logoutButton.onclick = () => { auth.signOut().then(() => { window.location.href = 'login.html'; }); };
            container.appendChild(logoutButton);
        }

        auth.onAuthStateChanged(async user => {
            if (user) {
                currentUser = user;
                userEmailSpan.textContent = `Logado como: ${user.email}`;
                adicionarBotaoLogout(userHeader);
                const userDocRef = db.collection('users').doc(user.uid);
                const doc = await userDocRef.get();
                if (doc.exists && doc.data().role === 'admin') {
                    painelDeControles.style.display = 'block';
                }
                await carregarPremiosERenderizarTudo();
                await checarGirosDiarios(user);
                await carregarHistorico(user.uid);
            } else {
                window.location.href = 'login.html';
            }
        });

        girarBtn.addEventListener('click', () => {
            if (isGirando || girosRestantes <= 0 || premios.length < 2) {
                if (premios.length < 2 && !isGirando) Swal.fire('Atenção!', 'A roleta precisa de pelo menos 2 prêmios para girar.', 'warning');
                return;
            }
            isGirando = true;
            girarBtn.disabled = true;
            girarBtn.textContent = 'Girando...';
            try { somGiro.play(); } catch(e) {}
            const indiceVencedor = Math.floor(Math.random() * premios.length);
            const premioVencedor = premios[indiceVencedor];
            const anguloPorFatia = 360 / premios.length;
            const anguloFinal = (5 * 360) + (360 - (indiceVencedor * anguloPorFatia) - (anguloPorFatia / 2));
            roleta.style.transition = 'transform 6s cubic-bezier(0.1, 0.7, 0.3, 1)';
            roleta.style.transform = `rotate(${anguloFinal}deg)`;
            setTimeout(() => {
                try { somGiro.pause(); somGiro.currentTime = 0; somVitoria.play(); } catch(e) {}
                Swal.fire({ icon: 'success', title: 'Parabéns!', html: `Você ganhou: <b>${premioVencedor.name}</b>` });
                isGirando = false;
                registrarGiro(currentUser.uid, premioVencedor);
            }, 6500);
        });

        addPremioBtn.addEventListener('click', async () => {
            const name = nomePremioInput.value;
            const color = corPremioInput.value;
            if (!name) { Swal.fire('Atenção!', 'O nome do prêmio não pode estar vazio.', 'warning'); return; }
            addPremioBtn.disabled = true;
            try {
                await db.collection('premios').add({ name, color });
                Swal.fire('Sucesso!', 'Prêmio adicionado.', 'success');
                nomePremioInput.value = '';
                await carregarPremiosERenderizarTudo();
            } catch (error) { Swal.fire('Erro!', 'Não foi possível adicionar o prêmio.', 'error'); }
            addPremioBtn.disabled = false;
        });
    
        listaPremiosUl.addEventListener('click', async (e) => {
            if (e.target.tagName !== 'BUTTON') return;
            const id = e.target.dataset.id;
            const result = await Swal.fire({ title: 'Você tem certeza?', text: "O prêmio será removido permanentemente!", icon: 'warning', showCancelButton: true, confirmButtonColor: '#3085d6', cancelButtonColor: '#d33', confirmButtonText: 'Sim, remover!', cancelButtonText: 'Cancelar' });
            if (result.isConfirmed) {
                try {
                    await db.collection('premios').doc(id).delete();
                    Swal.fire('Removido!', 'O prêmio foi removido.', 'success');
                    await carregarPremiosERenderizarTudo();
                } catch (error) { Swal.fire('Erro!', 'Não foi possível remover o prêmio.', 'error'); }
            }
        });
    </script>
</body>
</html>