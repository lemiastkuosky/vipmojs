<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roleta VIP - Diagnóstico</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            margin: 0; 
            background-color: #212121; 
            color: white; 
            padding: 20px; 
            box-sizing: border-box; 
        }
        h1 { 
            font-size: 2.5em; 
            margin-bottom: 20px; 
            color: #f1c40f;
            text-align: center;
        }

        .main-content {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 40px;
            width: 100%;
            flex-wrap: wrap;
        }

        .coluna-central {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex-shrink: 0;
        }

        .coluna-lateral {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 320px;
            max-width: 90vw;
            margin-top: 20px;
        }

        .info-box {
            background-color: #2c3e50;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #34495e;
        }

        .info-box h2 {
            margin-top: 0;
            font-size: 1.5em;
            color: #f1c40f;
            border-bottom: 2px solid #f1c40f;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        
        .info-box p {
            line-height: 1.6;
        }

        #lista-ganhadores {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 250px;
            overflow-y: auto;
        }

        #lista-ganhadores li {
            background-color: #34495e;
            padding: 10px 15px;
            margin-bottom: 8px;
            border-radius: 5px;
            font-size: 1.1em;
        }

        .roleta-container { 
            position: relative; 
            width: min(90vw, 450px); 
            aspect-ratio: 1 / 1; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
        }
        .roleta-container::before { 
            content: '▶'; 
            font-size: 50px; 
            color: #f1c40f; 
            position: absolute; 
            top: 50%; 
            right: -25px;
            transform: translateY(-50%); 
            z-index: 10; 
            text-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        #roleta { 
            width: 100%; 
            height: 100%; 
            border-radius: 50%; 
            border: 8px solid #ecf0f1; 
            box-shadow: 0 0 25px rgba(0, 0, 0, 0.6); 
            position: relative; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
        }

        /* --- MODIFICAÇÃO: Texto da roleta na vertical --- */
        .segmento-texto { 
            position: absolute; 
            text-align: center; 
            font-weight: bold; 
            font-size: 16px; 
            color: #fff; 
            transform-origin: center;
            /* Propriedades para texto vertical */
            writing-mode: vertical-rl;
            text-orientation: mixed;
            letter-spacing: 1px;
        }

        #girar-btn { 
            margin-top: 30px; 
            padding: 15px 40px; 
            font-size: 1.4em; 
            font-weight: bold; 
            color: #fff; 
            background-color: #e74c3c; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            transition: background-color 0.3s; 
        }
        #girar-btn:disabled { 
            background-color: #95a5a6; 
            cursor: not-allowed; 
        }
        .popup-overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(0, 0, 0, 0.7); 
            display: none; 
            justify-content: center; 
            align-items: center; 
            z-index: 1000; 
            padding: 15px;
        }
        .popup-box { 
            background: #fff; 
            color: #333; 
            padding: 30px; 
            border-radius: 15px; 
            text-align: center; 
            box-shadow: 0 5px 25px rgba(0,0,0,0.4);
            width: 100%;
            max-width: 400px;
        }

        @keyframes confete-fall {
            0% { transform: translateY(0) rotateZ(0); opacity: 1; }
            100% { transform: translateY(100vh) rotateZ(720deg); opacity: 0; }
        }

        .confete {
            position: fixed;
            top: -20px;
            width: 10px;
            height: 10px;
            pointer-events: none;
            z-index: 2000;
            animation: confete-fall 4s linear forwards;
        }
        
        /* --- MODIFICAÇÃO: Estilos para dispositivos portáteis --- */
        @media (max-width: 850px) {
            .main-content {
                flex-direction: column;
                align-items: center;
                gap: 20px;
            }
            .coluna-lateral {
                margin-top: 0;
                width: 100%;
                max-width: 500px; /* Limita a largura da coluna lateral em telas de tablet */
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 2em; /* Diminui o título principal */
            }
            .roleta-container::before {
                font-size: 40px; /* Diminui o ponteiro */
                right: -20px;
            }
            #girar-btn {
                font-size: 1.2em;
                padding: 12px 30px;
            }
            .info-box h2 {
                font-size: 1.3em;
            }
        }

    </style>
</head>
<body>

    <div class="main-content">
        <div class="coluna-central">
            <h1>ROLETA VIP</h1>
            <div class="roleta-container">
                <div id="roleta"></div>
            </div>
            <button id="girar-btn" disabled>CARREGANDO...</button>
        </div>
        <div class="coluna-lateral">
            <div class="info-box">
                <h2>Como Jogar?</h2>
                <p>1. Aguarde o carregamento completo dos prêmios na roleta.</p>
                <p>2. Clique no botão <strong>GIRAR!</strong> para iniciar o sorteio.</p>
                <p>3. Aguarde a roleta parar para revelar seu prêmio.</p>
                <p>4. Boa sorte!</p>
            </div>
            <div class="info-box">
                <h2>Últimos Ganhadores</h2>
                <ul id="lista-ganhadores">
                    </ul>
            </div>
        </div>
    </div>

    <div class="popup-overlay" id="popup-overlay"></div>
    <audio id="som-giro" src="som-giro.mp3" preload="auto" loop></audio>
    <audio id="som-premio" src="som-premio.mp3" preload="auto"></audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

      // Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyB1t-A3oZ09sUqHFjWSGUAgD3BNwNfibSc",
  authDomain: "roleta-vip-sorteio.firebaseapp.com",
  projectId: "roleta-vip-sorteio",
  storageBucket: "roleta-vip-sorteio.firebasestorage.app",
  messagingSenderId: "486644585290",
  appId: "1:486644585290:web:e1916aba17c9dd864fa7b3"
};

        try {
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);

            const roleta = document.getElementById('roleta');
            const btnGirar = document.getElementById('girar-btn');
            const popupOverlay = document.getElementById('popup-overlay');
            const somGiro = document.getElementById('som-giro');
            const somPremio = document.getElementById('som-premio');

            if (!roleta || !btnGirar || !popupOverlay) {
                throw new Error("Elemento HTML essencial não foi encontrado.");
            }

            let girando = false;
            let premios = [];
            let NUM_PREMIOS = 0;
            let anguloAtual = 0;
            const CORES = ["#e74c3c", "#3498db", "#2ecc71", "#f1c40f", "#9b59b6", "#1abc9c"];

            const carregarPremios = async () => {
                const q = query(collection(db, "premios"), orderBy("nome", "asc"));
                const querySnapshot = await getDocs(q);
                const pFirebase = [];
                querySnapshot.forEach((doc) => pFirebase.push(doc.data()));
                if (pFirebase.length === 0) throw new Error("Nenhum prêmio encontrado no Firestore.");
                premios = pFirebase;
                NUM_PREMIOS = premios.length;
            };

            const montarRoleta = () => {
                const angulo = 360 / NUM_PREMIOS;
                roleta.innerHTML = '';
                roleta.style.backgroundImage = `conic-gradient(${premios.map((p, i) => `${CORES[i % CORES.length]} ${i * angulo}deg, ${CORES[i % CORES.length]} ${(i + 1) * angulo}deg`).join(', ')})`;
                premios.forEach((p, i) => {
                    const txt = document.createElement('div');
                    txt.classList.add('segmento-texto');
                    const anguloTxt = (i * angulo) + (angulo / 2);
                    
                    // MODIFICAÇÃO: A rotação extra do texto foi removida do Javascript.
                    // O CSS 'writing-mode' agora controla a orientação vertical.
                    // O 'translate' posiciona o texto radialmente a partir do centro.
                    txt.style.transform = `rotate(${anguloTxt}deg) translate(100px)`;

                    txt.innerText = p.nome.toUpperCase(); // Coloca o texto em maiúsculas
                    roleta.appendChild(txt);
                });
            };

            const sortearPremioPonderado = () => {
                const v = premios.filter(p => p.peso > 0);
                if (v.length === 0) return Math.floor(Math.random() * NUM_PREMIOS);
                const t = v.reduce((a, p) => a + p.peso, 0);
                let s = Math.random() * t;
                for (const p of v) {
                    s -= p.peso;
                    if (s <= 0) return premios.findIndex(i => i === p);
                }
            };
            
            const esconderPopup = () => { popupOverlay.style.display = 'none'; };

            const criarConfete = () => {
                const confeteContainer = document.body;
                const coresConfete = ["#e74c3c", "#3498db", "#2ecc71", "#f1c40f", "#9b59b6", "#ecf0f1"];
                const quantidade = 150;
                for (let i = 0; i < quantidade; i++) {
                    const confete = document.createElement('div');
                    confete.classList.add('confete');
                    confete.style.left = `${Math.random() * 100}vw`;
                    confete.style.animationDuration = `${2 + Math.random() * 3}s`;
                    confete.style.animationDelay = `${Math.random() * 2}s`;
                    confete.style.backgroundColor = coresConfete[Math.floor(Math.random() * coresConfete.length)];
                    const size = `${5 + Math.random() * 10}px`;
                    confete.style.width = size;
                    confete.style.height = size;
                    
                    confeteContainer.appendChild(confete);

                    setTimeout(() => {
                        confete.remove();
                    }, 5000);
                }
            };

            const mostrarPopup = (premio) => {
                criarConfete();
                popupOverlay.innerHTML = `<div class="popup-box"><h2>Parabéns!</h2><p>Você ganhou:</p><p style="font-size:1.5em; font-weight:bold;">${premio}</p><button id="fechar-popup">Fechar</button></div>`;
                popupOverlay.style.display = 'flex';
                document.getElementById('fechar-popup').addEventListener('click', esconderPopup);
            };

            const girarRoleta = () => {
                if (girando) return;
                girando = true;
                btnGirar.disabled = true;
                
                console.clear(); 
                console.log("%c--- DIAGNÓSTICO DO GIRO ---", "color: yellow; font-size: 1.2em; font-weight: bold;");

                somGiro.currentTime = 0;
                somGiro.play();

                const premioSorteadoIndex = sortearPremioPonderado();
                const premioGanhado = premios[premioSorteadoIndex];
                console.log(`1. PRÊMIO SORTEADO PELO SISTEMA: "${premioGanhado.nome}" (Índice: ${premioSorteadoIndex})`);
                
                const anguloSegmento = 360 / NUM_PREMIOS;
                console.log(`2. Ângulo por fatia: ${anguloSegmento.toFixed(2)} graus.`);
                
                const girosExtras = 5;
                const anguloDoPremio = (premioSorteadoIndex * anguloSegmento) + (anguloSegmento / 2);
                console.log(`3. Ângulo alvo do prêmio (sem giros extras): ${anguloDoPremio.toFixed(2)} graus.`);
                
                const anguloDePartidaNormalizado = anguloAtual % 360;
                console.log(`4. Posição inicial da roleta (antes do giro): ${anguloDePartidaNormalizado.toFixed(2)} graus.`);
                
                const rotacaoTotal = - ( (girosExtras * 360) + anguloDoPremio - anguloDePartidaNormalizado );
                console.log(`5. CÁLCULO FINAL DA ROTAÇÃO: A roleta vai girar para ${rotacaoTotal.toFixed(2)} graus.`);

                anguloAtual = rotacaoTotal;

                roleta.style.transition = `transform 6s cubic-bezier(0.25, 1, 0.5, 1)`;
                roleta.style.transform = `rotate(${anguloAtual}deg)`;
                
                setTimeout(() => {
                    console.log(`6. ANIMAÇÃO CONCLUÍDA. Mostrando pop-up para o prêmio sorteado no passo 1.`);
                    console.log(`%cPRÊMIO FINAL A SER EXIBIDO: "${premioGanhado.nome}"`, "color: lightgreen; font-weight: bold;");
                    console.log("-------------------------------------");

                    somGiro.pause();
                    somPremio.play();
                    mostrarPopup(premioGanhado.nome);

                    const listaGanhadores = document.getElementById('lista-ganhadores');
                    if (listaGanhadores) {
                        const novoGanhador = document.createElement('li');
                        novoGanhador.textContent = premioGanhado.nome;
                        listaGanhadores.prepend(novoGanhador);
                    }

                    girando = false;
                    btnGirar.disabled = false;
                }, 6100);
            };

            async function init() {
                try {
                    await carregarPremios();
                    montarRoleta();
                    btnGirar.textContent = "GIRAR!";
                    btnGirar.disabled = false;
                    btnGirar.addEventListener('click', girarRoleta);
                } catch (e) {
                    console.error("Falha na inicialização:", e);
                    btnGirar.textContent = "ERRO AO CARREGAR";
                    alert("Não foi possível carregar os prêmios do servidor.");
                }
            }
            init();

        } catch (error) {
            console.error("Erro geral na inicialização do script:", error);
            document.body.innerHTML = `<h1 style='color:red; padding: 20px;'>ERRO CRÍTICO: ${error.message}</h1>`;
        }
    </script>
</body>
</html>