<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roleta de Prêmios</title>
    <link rel="stylesheet" href="style.css">
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>

    <header class="user-header">
        <span id="user-email"></span>
        </header>

    <div class="main-container">
        <div id="painel-admin" class="controles" style="display: none;">
            <h3>Gerenciar Prêmios e Pesos</h3>
            <p>O prêmio com maior peso tem mais chance de sair.</p>
            <ul id="admin-prize-list"></ul>
            <button id="update-weights-btn">Atualizar Pesos</button>
        </div>

        <div class="container">
            <div class="roleta-container">
                <div class="seta"></div>
                <div class="roleta" id="roleta"></div>
            </div>
            <button id="girar-btn">Girar a Roleta!</button>
            <p id="giros-restantes"></p>
        </div>
    </div>

    <div class="historico-container">
        <h2>Seu Histórico de Prêmios</h2>
        <ul id="historico-lista"></ul>
    </div>

    <audio id="som-giro" src="spinning.mp3" loop></audio>
    <audio id="som-vitoria" src="win.mp3"></audio>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="firebase-config.js"></script>
    
    <script>
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                // --- USUÁRIO LOGADO ---

                // 1. Elementos do DOM
                const painelAdmin = document.getElementById('painel-admin');
                const userHeader = document.querySelector('.user-header');
                const userEmailSpan = document.getElementById('user-email');
                const girarBtn = document.getElementById('girar-btn');
                const girosRestantesP = document.getElementById('giros-restantes');
                const roleta = document.getElementById('roleta');
                const historicoListaUl = document.getElementById('historico-lista');
                const somGiro = document.getElementById('som-giro');
                const somVitoria = document.getElementById('som-vitoria');

                // 2. Variáveis de Estado
                let currentUser = user;
                let premios = [];
                let isGirando = false;
                let limiteGirosUsuario = 5; // Valor padrão
                let girosRestantes = 0;

                // 3. Funções
                const carregarPremios = async () => { /* ... (código completo abaixo) ... */ };
                const renderizarRoleta = () => { /* ... (código completo abaixo) ... */ };
                const carregarHistorico = async (userId) => { /* ... (código completo abaixo) ... */ };
                const checarGirosDiarios = async (user) => { /* ... (código completo abaixo) ... */ };
                const atualizarStatusBotaoGirar = () => { /* ... (código completo abaixo) ... */ };
                const registrarGiro = async (userId, premioGanhado) => { /* ... (código completo abaixo) ... */ };
                const selecionarPremioPonderado = () => { /* ... (código completo abaixo) ... */ };
                const adicionarBotaoLogout = () => { /* ... (código completo abaixo) ... */ };

                // --- Definição Completa das Funções ---

                adicionarBotaoLogout = () => {
                    if (document.getElementById('btn-logout')) return;
                    const logoutButton = document.createElement('a'); // Usando 'a' para link
                    logoutButton.id = 'btn-logout';
                    logoutButton.textContent = 'Sair';
                    logoutButton.href = '#';
                    logoutButton.style.marginLeft = '20px';
                    logoutButton.onclick = (e) => {
                        e.preventDefault();
                        auth.signOut().then(() => { window.location.href = 'login.html'; });
                    };
                    userHeader.appendChild(logoutButton);
                };
                
                carregarPremios = async () => {
                    const snapshot = await db.collection('premios').get();
                    premios = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderizarRoleta();
                };

                renderizarRoleta = () => {
                    roleta.innerHTML = '';
                    if (premios.length === 0) return;
                    const anguloPorFatia = 360 / premios.length;
                    premios.forEach((premio, i) => {
                        const fatia = document.createElement('div');
                        fatia.style.cssText = `position: absolute; width: 50%; height: 50%; background-color: ${premio.color || '#cccccc'}; transform-origin: 100% 100%; transform: rotate(${i * anguloPorFatia}deg) skewX(${90 - anguloPorFatia}deg);`;
                        const textoSpan = document.createElement('span');
                        textoSpan.textContent = premio.name;
                        textoSpan.style.cssText = `position: absolute; left: 5%; top: 20%; width: 90%; color: white; font-size: 14px; font-weight: bold; text-shadow: 1px 1px 3px rgba(0,0,0,0.9); word-wrap: break-word; transform-origin: center; transform: skewX(${-(90 - anguloPorFatia)}deg) rotate(${anguloPorFatia / 2}deg); text-align: center;`;
                        fatia.appendChild(textoSpan);
                        roleta.appendChild(fatia);
                    });
                };
                
                carregarHistorico = async (userId) => {
                    historicoListaUl.innerHTML = '<li>Carregando...</li>';
                    const snapshot = await db.collection('sorteios').where('userId', '==', userId).orderBy('data', 'desc').limit(10).get();
                    if (snapshot.empty) {
                        historicoListaUl.innerHTML = '<li>Você ainda não ganhou prêmios.</li>';
                    } else {
                        historicoListaUl.innerHTML = '';
                        snapshot.forEach(doc => {
                            const sorteio = doc.data();
                            const li = document.createElement('li');
                            li.innerHTML = `<b>${sorteio.premio}</b> - <span>${sorteio.data.toDate().toLocaleString('pt-BR')}</span>`;
                            historicoListaUl.appendChild(li);
                        });
                    }
                };
                
                checarGirosDiarios = async (user) => {
                    const doc = await db.collection('users').doc(user.uid).get();
                    const userData = doc.data() || {};
                    limiteGirosUsuario = userData.limiteGiros ?? 5;
                    const hoje = new Date().toDateString();
                    const ultimoGiroDia = userData.ultimoGiroEm ? userData.ultimoGiroEm.toDate().toDateString() : null;
                    if (hoje !== ultimoGiroDia) {
                        await db.collection('users').doc(user.uid).update({ girosHoje: 0 });
                        girosRestantes = limiteGirosUsuario;
                    } else {
                        girosRestantes = Math.max(0, limiteGirosUsuario - (userData.girosHoje || 0));
                    }
                    atualizarStatusBotaoGirar();
                };

                atualizarStatusBotaoGirar = () => {
                    if (girosRestantes <= 0) {
                        girarBtn.disabled = true;
                        girosRestantesP.textContent = "Você não tem mais giros hoje.";
                    } else {
                        girarBtn.disabled = isGirando;
                        girosRestantesP.textContent = `Você tem ${girosRestantes} de ${limiteGirosUsuario} giros.`;
                    }
                };
                
                registrarGiro = async (userId, premioGanhado) => {
                    const userDocRef = db.collection('users').doc(userId);
                    await userDocRef.update({ 
                        girosHoje: firebase.firestore.FieldValue.increment(1),
                        ultimoGiroEm: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    await db.collection('sorteios').add({
                        userId: userId,
                        premio: premioGanhado.name,
                        data: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    girosRestantes--;
                    atualizarStatusBotaoGirar();
                    await carregarHistorico(userId);
                };

                selecionarPremioPonderado = () => {
                    const totalPeso = premios.reduce((sum, p) => sum + (p.peso || 1), 0);
                    let random = Math.random() * totalPeso;
                    for (const premio of premios) {
                        random -= (premio.peso || 1);
                        if (random <= 0) return premio;
                    }
                    return premios[premios.length - 1];
                };

                // 4. Lógica de Inicialização
                userEmailSpan.textContent = `Logado como: ${user.email}`;
                adicionarBotaoLogout();
                await carregarPremios();
                await checarGirosDiarios(user);
                await carregarHistorico(user.uid);

                // 5. Verifica se é Admin
                const userDoc = await db.collection('users').doc(user.uid).get();
                if (userDoc.exists && userDoc.data().role === 'admin') {
                    if(document.querySelector('.admin-link') == null) {
                         const adminLink = document.createElement('a');
                         adminLink.href = 'admin.html';
                         adminLink.textContent = 'Painel do Admin';
                         adminLink.className = 'admin-link';
                         userHeader.appendChild(adminLink);
                    }
                }

                // 6. Ativa os Event Listeners FINAIS

                girarBtn.addEventListener('click', () => {
                    if (isGirando || girosRestantes <= 0 || premios.length < 1) return;
                    
                    isGirando = true;
                    girarBtn.disabled = true;
                    girarBtn.textContent = 'Girando...';
                    try { somGiro.play(); } catch(e) {}
                    
                    const premioVencedor = selecionarPremioPonderado();
                    const indiceVencedor = premios.findIndex(p => p.id === premioVencedor.id);
                    const anguloPorFatia = 360 / premios.length;
                    const anguloFinal = (7 * 360) + (360 - (indiceVencedor * anguloPorFatia) - (anguloPorFatia / 2));
                    
                    roleta.style.transition = 'transform 6s cubic-bezier(0.25, 1, 0.5, 1)';
                    roleta.style.transform = `rotate(${anguloFinal}deg)`;

                    setTimeout(() => {
                        try { somGiro.pause(); somGiro.currentTime = 0; somVitoria.play(); } catch(e) {}
                        
                        Swal.fire({
                            icon: 'success',
                            title: 'Parabéns!',
                            html: `Você ganhou: <b>${premioVencedor.name}</b>`
                        });
                        
                        isGirando = false;
                        registrarGiro(currentUser.uid, premioVencedor);
                    }, 6500);
                });

            } else {
                window.location.href = 'login.html';
            }
        });
    </script>
</body>
</html>